<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>springbokjs-errors Source: /home/ubuntu/src/github.com/christophehurpeau/springbokjs-errors/lib/index.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">springbokjs-errors</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#log">log</a>
						</li>
						
						<li>
							<a href="global.html#parse">parse</a>
						</li>
						
						<li>
							<a href="global.html#parseErrorStack">parseErrorStack</a>
						</li>
						
						<li>
							<a href="global.html#setPathMapping">setPathMapping</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: /home/ubuntu/src/github.com/christophehurpeau/springbokjs-errors/lib/index.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">"use strict";

var _classProps = function(child, staticProps, instanceProps) {
  if (staticProps)
    Object.defineProperties(child, staticProps);

  if (instanceProps)
    Object.defineProperties(child.prototype, instanceProps);
};

require('es6-shim/es6-shim');
var stackTrace = require('stack-trace');
var fs = require('fs');
var path = require('path');
var sourceMap = require("source-map");

var sourceMapping;

var ParsedError = function() {
  var ParsedError = function ParsedError(err) {
      this.name = err.name;
      this.message = err.message;
      this.originalStack = err.stack;
  };

  _classProps(ParsedError, null, {
    toString: {
      writable: true,

      value: function() {
          return this.name + ': ' + this.message + "\n" + this.stack.toString();
      }
    }
  });

  return ParsedError;
}();

var StackTrace = function() {
  var StackTrace = function StackTrace() {
      this.items = [];
  };

  _classProps(StackTrace, null, {
    forEach: {
      writable: true,

      value: function() {
          return this.items.forEach.apply(this.items, arguments);
      }
    },

    toString: {
      writable: true,

      value: function() {
          var str = '';
          this.render(function(string) {
              str += string + "\n";
          });
          return str;
      }
    },

    render: {
      writable: true,

      value: function(log) {
          this.forEach(function(line) {
              line.render(log);
          });
      }
    }
  });

  return StackTrace;
}();

var StackTraceItem = function() {
  var StackTraceItem = function StackTraceItem(item) {
      this.fileName = item.fileName;
      this.lineNumber = item.lineNumber;
      this.columnNumber = item.columnNumber;
      this.typeName = item.typeName;
      this.methodName = item.methodName;
      this.native = item.native;
      this.file = item.file;

      if (sourceMapping &amp;&amp; item.fileName &amp;&amp; item.fileName.startsWith(sourceMapping.current)) {
          this.realFileName = sourceMapping.source
                                  + item.fileName.substr(sourceMapping.current.length);
      } else {
          this.realFileName = item.fileName;
      }
  };

  _classProps(StackTraceItem, null, {
    getFileName: {
      writable: true,

      value: function() {
          return this.fileName;
      }
    },

    getLineNumber: {
      writable: true,

      value: function() {
          return this.line;
      }
    },

    getColumnNumber: {
      writable: true,

      value: function() {
          return this.column + 1;
      }
    },

    getScriptNameOrSourceURL: {
      writable: true,

      value: function() {
          return this.fileName;
      }
    },

    render: {
      writable: true,

      value: function(log) {
          var fullPath = this.realFileName + ':' + this.lineNumber + ':' + this.columnNumber;
          log(
              '    at '
               + ( this.methodName || this.typeName ? (this.typeName &amp;&amp; this.typeName + '.')
               + (this.methodName || '&lt;anonymous>')
               + ' (' + fullPath + ')' : fullPath));
          //line.native
      }
    }
  });

  return StackTraceItem;
}();



/**
 * Set path mapping, for instance when you have a vm or docker
 *
 * @param {String} currentPath
 * @param {String} sourcePath
 */
exports.setPathMapping = function(currentPath, sourcePath) {
    sourceMapping = Object.freeze({ current: currentPath, source: sourcePath });
};

/**
 * Parse an error and extract its stack trace
 * @param  {Error} err
 * @return {ParsedError}
 */
exports.parse = function(err) {
    var parsedError = new ParsedError(err);
    parsedError.stack = exports.parseErrorStack(err);
    return parsedError;
};

/**
 * Parse an error and extract its stack trace
 * @param  {Error} err
 * @return {StackTrace}
 */
exports.parseErrorStack = function(err) {
    var finalStack = new StackTrace();
    var stack = stackTrace.parse(err);

    var files = new Map();
    stack.forEach(function(line) {
        if (!line.fileName || files.has(line.fileName)) {
            return;
        }
        files.set(line.fileName, {});
    });

    files.forEach(function(file, fileName) {
        if (fileName.startsWith('/')) {
            try {
                var fileNameMap = fileName + '.map';
                var fileContent = fs.readFileSync(fileName).toString();
                var match = /\/\/[#@]\s*sourceMappingURL=(.*)\s*$/m.exec(fileContent);
                if (match &amp;&amp; match[1] &amp;&amp; match[1][0] === '/') {
                    fileNameMap = match[1];
                }
                var contents = fs.readFileSync(fileNameMap).toString();
                file.map = new sourceMap.SourceMapConsumer(contents);
                if (file.map.sourcesContent) {
                    var sourceIndex = file.map.sources.indexOf(file.map.file);
                    file.contents = sourceIndex !== -1 &amp;&amp; file.map.sourcesContent[sourceIndex];
                }
                if (!file.contents) {
                    var sourceRoot = path.resolve(path.dirname(fileName), file.map.sourceRoot);
                    if (sourceRoot.slice(-1) !== '/') {
                        sourceRoot += '/';
                    }
                    file.sourceFileName = sourceRoot + file.map.file;
                    file.contents = fs.readFileSync(file.sourceFileName).toString();
                }
                // TODO lazy loading
                //, path.resolve(file.map.sourceRoot, original.source)
            } catch(e) {
                //console.log(e.stack);
            }
        }
    });

    stack.forEach(function(line) {
        var file = files.get(line.fileName);
        if (file &amp;&amp; file.map) {
            var original = file.map.originalPositionFor({ line: line.lineNumber, column: line.columnNumber });
            if (original.source) {
                //, path.resolve(file.map.sourceRoot, original.source)
                line.fileName = file.sourceFileName;
                line.lineNumber = original.line;
                line.columnNumber = original.column;
                if (original.name) {
                    line.methodName = original.name;
                }
            }
            line.file = file;

        }
        finalStack.items.push(new StackTraceItem(line));
    });

    return finalStack;
};


/**
 * Parse then log an error with logger.error
 * @param  {Error} err
 */
exports.log = function(err) {
    /* global logger */
    if (typeof err !== 'object') {
        (global.logger &amp;&amp; logger.error || console.error)(err.message || err);
    } else {
        var parsedError = exports.parse(err);
        (global.logger &amp;&amp; logger.error || console.error)(parsedError.toString());
    }
};

//# sourceMappingURL=index.js.map</pre>
	</article>
</section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a>
		on 2014-11-09T00:28:26+00:00 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	

</body>
</html>
