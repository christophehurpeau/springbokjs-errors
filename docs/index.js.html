<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global BROWSER, NODEJS */
import { readFileSync } from 'fs'; // #if NODEJS
import ParsedError from './ParsedError';
import StackTrace from './StackTrace';
import StackTraceItem from './StackTraceItem';

const path = require('path');
const stackTrace = require('stack-trace');
const sourceMap = require('source-map');

let sourceMapping;

/**
 * Set path mapping, for instance when you have a vm or docker
 *
 * @param {String} currentPath
 * @param {String} sourcePath
*/
export function setPathMapping(currentPath, sourcePath) {
  sourceMapping = Object.freeze({ current: currentPath, source: sourcePath });
}

/**
 * Parse an error and extract its stack trace
 *
 * @param  {Error} err
 * @return {ParsedError}
*/
export function parse(err) {
  let parsedError = new ParsedError(err, parseErrorStack(err));

  if (err.previous) {
    parsedError.previous = parse(err.previous);
  }

  return parsedError;
}

/**
 * Parse an error and extract its stack trace
 *
 * @param  {Error} err
 * @return {StackTrace}
*/
export function parseErrorStack(err) {
  let finalStack = new StackTrace();
  let stack = stackTrace.parse(err);

  const libFiles = new Map();
  const sourceFiles = new Map();

  stack.forEach(line => {
    const fileName = line.fileName;
    let file;

    if (fileName &amp;&amp; fileName.startsWith('/')) {
      if (libFiles.has(fileName)) {
        file = libFiles.get(fileName);
      } else if (BROWSER) {
        libFiles.set(fileName, file = false);
      } else {
        file = {};
        const dirname = path.dirname(fileName);
        try {
          const fileContent = readFileSync(fileName).toString();
          file.fileName = fileName;
          file.contents = fileContent;
          libFiles.set(fileName, file);

          try {
            let fileNameMap = `${ fileName }.map`;
            const match = /\/\/[#@]\s*sourceMappingURL=(.*)\s*$/m.exec(fileContent);
            if (match &amp;&amp; match[1] &amp;&amp; match[1][0] === '/') {
              fileNameMap = path.resolve(dirname, match[1]);
            }

            const contents = readFileSync(fileNameMap).toString();
            file.fileNameMap = fileNameMap;
            file.map = new sourceMap.SourceMapConsumer(contents);

            if (file.map.sourceRoot) {
              file.sourceRoot = path.resolve(dirname, file.map.sourceRoot);
            } else {
              file.sourceRoot = path.dirname(fileName);
            }
          } catch (e) {}
        } catch (e) {
          libFiles.set(fileName, file = false);
        }
      }
    }

    if (file &amp;&amp; file.map) {
      const original = file.map.originalPositionFor({
        line: line.lineNumber,
        column: line.columnNumber
      });
      let originalFile;

      if (original.source) {
        const originalFilePath = path.resolve(file.sourceRoot, original.source);

        if (sourceFiles.has(originalFilePath)) {
          originalFile = sourceFiles.get(originalFilePath);
        } else {
          originalFile = { fileName: original.source, filePath: originalFilePath };
          sourceFiles.set(originalFilePath, originalFile);

          if (file.map.sourcesContent) {
            const sourceIndex = file.map.sources.indexOf(original.source);
            originalFile.contents = sourceIndex !== -1 &amp;&amp; file.map.sourcesContent[sourceIndex];
          }

          if (NODEJS) {
            if (!originalFile.contents) {
              Object.defineProperty(originalFile, 'contents', {
                configurable: true,
                get: function get() {
                  let contents;
                  try {
                    contents = readFileSync(originalFilePath).toString();
                  } catch (err) {}

                  Object.defineProperty(originalFile, 'contents', { value: contents });
                  return contents;
                }
              });
            }
          }
        }

        line.compiledFileName = line.fileName;
        line.compiledLineNumber = line.lineNumber;
        line.compiledColumnNumber = line.columnNumber;

        line.file = originalFile;
        line.fileName = originalFile.filePath;
        line.lineNumber = original.line;
        line.columnNumber = original.column;
        if (original.name) {
          line.methodName = original.name;
        }
      }
    }

    if (!line.file &amp;&amp; file &amp;&amp; file.contents) {
      line.file = {
        fileName: file.fileName,
        filePath: file.fileName,
        contents: file.contents
      };
    }

    finalStack.items.push(new StackTraceItem(line, sourceMapping));
  });

  return finalStack;
}
//# sourceMappingURL=index.js.map</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#forEach">forEach</a></li><li><a href="global.html#message">message</a></li><li><a href="global.html#name">name</a></li><li><a href="global.html#originalStack">originalStack</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#parseErrorStack">parseErrorStack</a></li><li><a href="global.html#setPathMapping">setPathMapping</a></li><li><a href="global.html#tag">tag</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Fri Sep 09 2016 21:08:29 GMT+0000 (UTC)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
