{"version":3,"sources":["../src/index.js"],"names":["setPathMapping","parse","parseErrorStack","path","require","stackTrace","sourceMap","sourceMapping","currentPath","sourcePath","Object","freeze","current","source","err","parsedError","previous","finalStack","stack","libFiles","Map","sourceFiles","forEach","line","fileName","file","startsWith","has","get","dirname","fileContent","toString","contents","set","fileNameMap","match","exec","resolve","map","SourceMapConsumer","sourceRoot","e","original","originalPositionFor","lineNumber","column","columnNumber","originalFile","originalFilePath","filePath","sourcesContent","sourceIndex","sources","indexOf","defineProperty","configurable","value","compiledFileName","compiledLineNumber","compiledColumnNumber","name","methodName","items","push"],"mappings":"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","file":"index.js","sourcesContent":["/* global BROWSER, NODEJS */\nimport { readFileSync } from 'fs'; // #if NODEJS\nimport ParsedError from './ParsedError';\nimport StackTrace from './StackTrace';\nimport StackTraceItem from './StackTraceItem';\n\nconst path = require('path');\nconst stackTrace = require('stack-trace');\nconst sourceMap = require('source-map');\n\nlet sourceMapping;\n\n/**\n * Set path mapping, for instance when you have a vm or docker\n *\n * @param {String} currentPath\n * @param {String} sourcePath\n */\nexport function setPathMapping(currentPath, sourcePath) {\n  sourceMapping = Object.freeze({ current: currentPath, source: sourcePath });\n}\n\n/**\n * Parse an error and extract its stack trace\n *\n * @param  {Error} err\n * @return {ParsedError}\n */\nexport function parse(err) {\n  let parsedError = new ParsedError(err, parseErrorStack(err));\n\n  if (err.previous) {\n    parsedError.previous = parse(err.previous);\n  }\n\n  return parsedError;\n}\n\n/**\n * Parse an error and extract its stack trace\n *\n * @param  {Error} err\n * @return {StackTrace}\n */\nexport function parseErrorStack(err) {\n  let finalStack = new StackTrace();\n  let stack = stackTrace.parse(err);\n\n  const libFiles = new Map();\n  const sourceFiles = new Map();\n\n  stack.forEach((line) => {\n    const fileName = line.fileName;\n    let file;\n\n    if (fileName && fileName.startsWith('/')) {\n      if (libFiles.has(fileName)) {\n        file = libFiles.get(fileName);\n      } else if (BROWSER) {\n        libFiles.set(fileName, file = false);\n      } else {\n        file = {};\n        const dirname = path.dirname(fileName);\n        try {\n          const fileContent = readFileSync(fileName).toString();\n          file.fileName = fileName;\n          file.contents = fileContent;\n          libFiles.set(fileName, file);\n\n          try {\n            let fileNameMap = `${fileName}.map`;\n            const match = /\\/\\/[#@]\\s*sourceMappingURL=(.*)\\s*$/m.exec(fileContent);\n            if (match && match[1] && match[1][0] === '/') {\n              fileNameMap = path.resolve(dirname, match[1]);\n            }\n\n            const contents = readFileSync(fileNameMap).toString();\n            file.fileNameMap = fileNameMap;\n            file.map = new sourceMap.SourceMapConsumer(contents);\n\n            if (file.map.sourceRoot) {\n              file.sourceRoot = path.resolve(dirname, file.map.sourceRoot);\n            } else {\n              file.sourceRoot = path.dirname(fileName);\n            }\n          } catch (e) {\n          }\n        } catch (e) {\n          libFiles.set(fileName, file = false);\n        }\n      }\n    }\n\n    if (file && file.map) {\n      const original = file.map.originalPositionFor({\n        line: line.lineNumber,\n        column: line.columnNumber,\n      });\n      let originalFile;\n\n      if (original.source) {\n        const originalFilePath = path.resolve(file.sourceRoot, original.source);\n\n        if (sourceFiles.has(originalFilePath)) {\n          originalFile = sourceFiles.get(originalFilePath);\n        } else {\n          originalFile = { fileName: original.source, filePath: originalFilePath };\n          sourceFiles.set(originalFilePath, originalFile);\n\n          if (file.map.sourcesContent) {\n            const sourceIndex = file.map.sources.indexOf(original.source);\n            originalFile.contents = sourceIndex !== -1 && file.map.sourcesContent[sourceIndex];\n          }\n\n          if (NODEJS) {\n            if (!originalFile.contents) {\n              Object.defineProperty(originalFile, 'contents', {\n                configurable: true,\n                get: function get() {\n                  let contents;\n                  try {\n                    contents = readFileSync(originalFilePath).toString();\n                  } catch (err) {\n                  }\n\n                  Object.defineProperty(originalFile, 'contents', { value: contents });\n                  return contents;\n                },\n              });\n            }\n          }\n        }\n\n        line.compiledFileName = line.fileName;\n        line.compiledLineNumber = line.lineNumber;\n        line.compiledColumnNumber = line.columnNumber;\n\n        line.file = originalFile;\n        line.fileName = originalFile.filePath;\n        line.lineNumber = original.line;\n        line.columnNumber = original.column;\n        if (original.name) {\n          line.methodName = original.name;\n        }\n      }\n    }\n\n    if (!line.file && file && file.contents) {\n      line.file = {\n        fileName: file.fileName,\n        filePath: file.fileName,\n        contents: file.contents,\n      };\n    }\n\n    finalStack.items.push(new StackTraceItem(line, sourceMapping));\n  });\n\n  return finalStack;\n}\n"]}