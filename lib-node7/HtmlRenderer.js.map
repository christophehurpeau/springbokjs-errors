{"version":3,"sources":["../src/HtmlRenderer.js"],"names":["tag","tagName","attributes","content","contentEscape","str","Object","keys","forEach","key","HtmlRenderer","constructor","options","assign","fileProtocol","openLocalFile","filePath","lineNumber","columnNumber","realFilePath","generatedPath","sourcePath","startsWith","substr","length","replaceAppInFilePath","render","error","name","message","production","renderStack","stackTrace","item","i","file","contents","compiledFileName","fileName","realFileName","native","functionName","typeName","methodName","realCompiledFileName","compiledLineNumber","compiledColumnNumber","highlightLine","withLineNumbers","minmax","hcontents","err","split","ok","firstLine","start","lineContent","end","Math","max","slice","lines","line","style","startNumber","_lines","contentLine"],"mappings":"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","file":"HtmlRenderer.js","sourcesContent":["/* eslint-disable max-len, max-lines */\n\nimport escape from 'escape-html';\nimport highlight from 'eshighlight-fb';\nimport { parseErrorStack } from './index';\nimport StackTrace from './StackTrace';\n\nfunction tag(tagName, attributes, content, contentEscape) {\n  attributes = attributes || {};\n  let str = '';\n  Object.keys(attributes).forEach(key => {\n    str += ` ${key}`;\n    if (attributes[key]) {\n      str += `=\"${attributes[key] === true ? key : escape(attributes[key])}\"`;\n    }\n  });\n\n  return `<${tagName}${str}${content == null ? '/' :\n                  `>${contentEscape ? escape(content) : content}</${tagName}`}>`;\n}\n\nexport default class HtmlRenderer {\n  constructor(options) {\n    this.options = Object.assign({\n      fileProtocol: 'file',\n    }, options);\n  }\n\n  /**\n   * @ignore\n   */\n  openLocalFile(filePath, lineNumber, columnNumber, realFilePath) {\n    if (this.openLocalFile.generatedPath && this.openLocalFile.sourcePath\n                     && filePath.startsWith(this.openLocalFile.generatedPath)) {\n      filePath = this.openLocalFile.sourcePath + filePath.substr(this.openLocalFile.generatedPath.length);\n    }\n\n    return `<a download href=\"${this.options.fileProtocol}://${escape(realFilePath || filePath)}`\n               + `${!lineNumber ? '' : `?${lineNumber}${!columnNumber ? '' : `:${columnNumber}`}`}\">`;\n  }\n\n  /**\n   * @ignore\n   */\n  replaceAppInFilePath(filePath) {\n    if (this.openLocalFile.generatedPath) {\n      filePath = `APP/${filePath.substr(this.openLocalFile.generatedPath.length)}`;\n    }\n\n    return filePath;\n  }\n\n  /**\n   * @ignore\n   */\n  render(error) {\n    let str = '<div style=\"text-align: left\">';\n    str += `<h4>${error.name}</h4>\\n`;\n    if (error.message) {\n      str += '<pre style=\"background:#FFF;color:#222;border:0;font-size:1em;white-space:pre-wrap;word-wrap:break-word\">';\n      str += escape(error.message);\n      str += '</pre>';\n    }\n\n    str += '<h5 style=\"background:#FFDDAA;color:#333;border:1px solid #E07308;padding:1px 2px;\">Call Stack:</h5>\\n';\n\n    if (!this.options.production) {\n      str += `<pre style=\"background:#FFF;color:#222;border:0\">${this.renderStack(error)}</pre>`;\n    }\n\n    return str;\n  }\n\n  /**\n   * @ignore\n   */\n  renderStack(error) {\n    let stackTrace = error.stackTrace instanceof StackTrace ? error.stackTrace : parseErrorStack(error);\n\n    let str = `<style>.string{ color: #EC7600; }\n.keyword, .null{ font-weight: bold; color: #93C763; }\n.numeric{ color: #FACD22; }\n.line-comment{ color: #66747B; }\n.identifier{ }\n.control-flow{ color: #93C763; }\n.azerty1{ color: #66747B; }\n.azerty2{ color: #678CB1; }\n.azerty5{ color: #F1F2F3; }\n.azerty6{ color: #8AC763; }\n.azerty7{ color: #E0E2E4; }\n.azerty9{ color: purple; }\n</style>`;\n    stackTrace.forEach((item, i) => {\n      if ((item.file && item.file.contents) || item.compiledFileName) {\n        str += '<span><a href=\"javascript:;\" style=\"color:#CC7A00;text-decoration:none;outline:none;\" '\n                        + 'onclick=\"var el=this.parentNode.nextElementSibling; el.style.display=el.style.display==\\'none\\'?\\'block\\':\\'none\\';\">';\n      }\n\n      str += `#${i} `;\n      if (item.fileName && item.fileName.startsWith('/')) {\n        str += this.openLocalFile(item.fileName, item.lineNumber, item.columnNumber, item.realFileName);\n      }\n\n      if (!item.native) {\n        str += this.replaceAppInFilePath(item.realFileName || item.fileName);\n        str += `:${item.lineNumber}:${item.columnNumber}`;\n      }\n\n      if (item.fileName) {\n        str += '</a> ';\n      }\n\n      if (item.functionName) {\n        str += item.functionName;\n      } else if (item.typeName) {\n        str += `${item.typeName}.${item.methodName || '<anonymous>'}`;\n      }\n\n      if (item.native) {\n        str += ' [native]';\n      }\n\n      if ((item.file && item.file.contents) || item.compiledFileName) {\n        str += '</a></span>';\n        str += '<div style=\"display:none\">';\n        if (item.compiledFileName) {\n          str += '<div style=\"margin-top: 5px\">';\n          str += '<b>Compiled path :</b><br />';\n          if (item.realCompiledFileName && item.realCompiledFileName.startsWith('/')) {\n            str += this.openLocalFile(item.compiledFileName, item.compiledLineNumber,\n                                item.compiledColumnNumber, item.realCompiledFileName);\n          }\n\n          str += this.replaceAppInFilePath(item.realCompiledFileName);\n          str += `:${item.compiledLineNumber}:${item.compiledColumnNumber}`;\n          if (item.realCompiledFileName && item.realCompiledFileName.startsWith('/')) {\n            str += '</a>';\n          }\n\n          str += '</div>';\n        }\n\n        if (item.file && item.file.contents) {\n          str += '<div style=\"margin-top: 5px\">';\n          str += '<b>File content :</b><br />';\n          str += this.highlightLine(item.file.contents, item.lineNumber, item.columnNumber);\n          str += '</div>';\n        }\n\n        str += '</div>';\n      }\n\n      str += '\\n';\n    });\n\n    return str;\n  }\n\n  /**\n   * @ignore\n   */\n  highlightLine(contents, lineNumber /* , columnNumber */) {\n    let style = 'background:#3F1F1F;';\n    let withLineNumbers = true;\n    let minmax = 4;\n\n    let hcontents;\n    try {\n      hcontents = highlight(contents);\n    } catch (err) {\n      hcontents = escape(contents);\n    }\n\n    hcontents = hcontents.split(/\\r\\n|\\n\\r|\\n|\\r/);\n\n    let ok = lineNumber <= hcontents.length;\n    let firstLine;\n    let start;\n    let lineContent;\n    let end;\n\n    if (ok) {\n      firstLine = Math.max(0, minmax ? lineNumber - 1 - minmax : 0);\n      start = hcontents.slice(firstLine, lineNumber - 1);\n      lineContent = lineNumber === 0 ? '' : hcontents[lineNumber - 1];\n      end = hcontents.slice(lineNumber, lineNumber + minmax);\n    } else {\n      start = hcontents;\n    }\n\n        /* if (withLineNumbers) {\n            // $withLineNumbers = '%'.strlen((string)($ok ? $line+$minmax : $minmax+1)).'d';\n        } */\n\n    let content = this.lines(withLineNumbers, ok ? firstLine + 1 : 1, start);\n    if (ok) {\n      let attributes = { style };\n      content += this.line(withLineNumbers, lineNumber, attributes, lineContent);\n      content += this.lines(withLineNumbers, lineNumber + 1, end);\n    }\n\n    let preAttrs = { style: 'background:#0F0F0F;color:#E0E2E4;border:0;padding:0;position:relative;' };\n    return tag('pre', preAttrs, content, false);\n  }\n\n  /**\n   * @ignore\n   */\n  lines(withLineNumbers, startNumber, _lines) {\n    let content = '';\n    _lines.forEach((line) => {\n      content += this.line(withLineNumbers, startNumber + 1, {}, line);\n    });\n    return content;\n  }\n\n  /**\n   * @ignore\n   */\n  line(withLineNumbers, lineNumber, attributes, contentLine) {\n    attributes.style = `${attributes.style || ''}white-space:pre-wrap;`\n            + `${withLineNumbers ? 'padding-left:20px;' : ''}`;\n\n    if (withLineNumbers) {\n      contentLine = '<i style=\"color:#AAA;font-size:7pt;position:absolute;left:1px;padding-top:1px;\">'\n                            + `${lineNumber}</i>${contentLine}`;\n    }\n\n    return tag('div', attributes, contentLine);\n  }\n}\n"]}